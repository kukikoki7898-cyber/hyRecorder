<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리들의 말하기 연습</title>
    <style>
        body {
            background-color: #FFFBEB; /* 파스텔톤 크림색 */
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        h1 {
            color: #4A4A4A;
            text-align: center;
            font-size: 2.2em;
            font-weight: 600;
        }

        .list-container {
            width: 100%;
            max-width: 700px;
            max-height: 70vh; 
            overflow-y: auto; 
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* 스크롤바 디자인 */
        .list-container::-webkit-scrollbar { width: 8px; }
        .list-container::-webkit-scrollbar-thumb { background-color: #D4D4D4; border-radius: 4px; }
        .list-container::-webkit-scrollbar-track { background-color: transparent; }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #FFFFFF;
            padding: 18px 25px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .item:last-child { margin-bottom: 0; }

        .item-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #555;
        }

        .buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            min-width: 110px; /* 버튼 크기가 변하지 않도록 최소 너비 지정 */
            justify-content: center;
        }
        
        /* 비활성화된 버튼 스타일 */
        .btn:disabled {
            background-color: #E0E0E0; /* 회색 */
            color: #9E9E9E;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn:disabled:hover {
            transform: none; /* 호버 효과 제거 */
        }

        /* 녹음하기 버튼 (파스텔 그린) */
        .btn-record {
            background-color: #C8E6C9;
            color: #256029;
        }
        .btn-record:not(:disabled):hover {
            background-color: #A5D6A7;
            transform: scale(1.05);
        }
        
        /* 녹음 중 버튼 (파스텔 레드) */
        .btn-record.recording {
            background-color: #FFCDD2; /* 연한 빨강 */
            color: #B71C1C;
        }
        .btn-record.recording:not(:disabled):hover {
            background-color: #EF9A9A;
        }


        /* 재생하기 버튼 (파스텔 블루) */
        .btn-play {
            background-color: #B3E5FC;
            color: #01579B;
        }
        .btn-play:not(:disabled):hover {
            background-color: #81D4FA;
            transform: scale(1.05);
        }

        /* 다시 녹음하기 버튼 (파스텔 옐로우) */
        .btn-rerecord {
            background-color: #FFECB3;
            color: #6D4C00;
        }
        .btn-rerecord:not(:disabled):hover {
            background-color: #FFE082;
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <h1>🎙️ 우리들의 말하기 연습</h1>
    <div class="list-container" id="list-container">
        </div>

    <script>
        // --- 1. 전역 변수 설정 ---

        let mediaRecorder; // MediaRecorder 인스턴스
        let mediaStream;   // 마이크 스트림
        let audioChunks = []; // 녹음된 오디오 청크 배열
        let currentRecordingButton = null; // 현재 녹음 중인 버튼
        
        // 각 번호별로 녹음된 오디오 Blob을 저장할 Map
        const audioStore = new Map();

        // --- 2. 핵심 기능 함수 ---

        /**
         * 마이크 권한을 요청하고 스트림을 준비합니다.
         */
        async function setupStream() {
            try {
                // 한 번만 스트림을 요청합니다.
                if (!mediaStream) {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
            } catch (err) {
                console.error("마이크 접근 오류:", err);
                alert("마이크 권한이 필요합니다. 브라우저 설정을 확인해주세요.");
            }
        }

        /**
         * 녹음 시작/중지 처리를 담당하는 함수
         * @param {number} itemNumber - 항목 번호 (1~15)
         * @param {HTMLElement} recordBtn - 클릭된 '녹음' 버튼
         * @param {HTMLElement} playBtn - 해당 항목의 '재생' 버튼
         * @param {HTMLElement} rerecordBtn - 해당 항목의 '다시 녹음' 버튼
         */
        async function handleRecordClick(itemNumber, recordBtn, playBtn, rerecordBtn) {
            
            // 다른 항목이 이미 녹음 중일 때
            if (mediaRecorder && mediaRecorder.state === 'recording' && currentRecordingButton !== recordBtn) {
                alert("다른 항목을 녹음 중입니다. 먼저 녹음을 중지해주세요.");
                return;
            }

            // 마이크 스트림 준비 (최초 1회)
            await setupStream();
            if (!mediaStream) return; // 사용자가 권한을 거부한 경우

            // --- 녹음 중지 ---
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                
            // --- 녹음 시작 ---
            } else {
                audioChunks = []; // 청크 초기화
                mediaRecorder = new MediaRecorder(mediaStream);

                // (1) 녹음 데이터가 들어올 때
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                // (2) 녹음이 중지될 때
                mediaRecorder.onstop = () => {
                    // 녹음된 데이터를 Blob으로 합침
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // 해당 번호에 Blob 저장
                    audioStore.set(itemNumber, audioBlob);

                    // 버튼 상태 업데이트
                    recordBtn.innerHTML = '🎤 <span>녹음하기</span>';
                    recordBtn.classList.remove('recording');
                    playBtn.disabled = false; // 재생 버튼 활성화
                    rerecordBtn.disabled = false; // 다시 녹음 버튼 활성화
                    
                    currentRecordingButton = null;
                };

                // 녹음 시작
                mediaRecorder.start();
                
                // 버튼 상태 업데이트 (녹음 중)
                recordBtn.innerHTML = '🔴 <span>녹음 중지</span>';
                recordBtn.classList.add('recording');
                playBtn.disabled = true; // 녹음 중에는 재생 비활성화
                rerecordBtn.disabled = true; // 녹음 중에는 다시 녹음 비활성화
                
                currentRecordingButton = recordBtn;
            }
        }

        /**
         * 재생 버튼 클릭 시 오디오를 재생하는 함수
         * @param {number} itemNumber - 항목 번호 (1~15)
         */
        function handlePlayClick(itemNumber) {
            const audioBlob = audioStore.get(itemNumber);
            
            if (audioBlob) {
                // Blob을 재생 가능한 URL로 변환
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.play();

                // 재생이 끝나면 메모리 확보를 위해 URL 해제
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                };
            } else {
                alert("재생할 녹음 파일이 없습니다. 먼저 녹음을 해주세요.");
            }
        }

        // --- 3. 화면 구성 (HTML 동적 생성) ---

        const listContainer = document.getElementById('list-container');

        // 브라우저가 MediaRecorder를 지원하는지 확인
        if (!navigator.mediaDevices || !window.MediaRecorder) {
            listContainer.innerHTML = '<p style="color: red; text-align: center;">죄송합니다. 이 브라우저는 음성 녹음을 지원하지 않습니다.</p>';
        } else {
            // 1번부터 15번까지 항목 생성
            for (let i = 1; i <= 15; i++) {
                
                // (이 변수 선언이 중요합니다. 클로저 문제 방지)
                const itemNumber = i; 

                const item = document.createElement('div');
                item.className = 'item';

                const itemNumberSpan = document.createElement('span');
                itemNumberSpan.className = 'item-number';
                itemNumberSpan.textContent = `${itemNumber}번`;

                const buttons = document.createElement('div');
                buttons.className = 'buttons';

                // '녹음하기' 버튼
                const recordButton = document.createElement('button');
                recordButton.className = 'btn btn-record';
                recordButton.innerHTML = '🎤 <span>녹음하기</span>';

                // '재생하기' 버튼
                const playButton = document.createElement('button');
                playButton.className = 'btn btn-play';
                playButton.innerHTML = '▶️ <span>재생하기</span>';
                playButton.disabled = true; // 처음에는 비활성화

                // '다시 녹음하기' 버튼
                const rerecordButton = document.createElement('button');
                rerecordButton.className = 'btn btn-rerecord';
                rerecordButton.innerHTML = '🔄 <span>다시 녹음</span>';
                rerecordButton.disabled = true; // 처음에는 비활성화

                // --- 4. 이벤트 리스너 연결 ---

                // '녹음하기' 버튼 클릭 시
                recordButton.onclick = () => {
                    handleRecordClick(itemNumber, recordButton, playButton, rerecordButton);
                };

                // '다시 녹음하기' 버튼 클릭 시 (녹음하기와 동일한 기능 수행)
                rerecordButton.onclick = () => {
                    handleRecordClick(itemNumber, recordButton, playButton, rerecordButton);
                };

                // '재생하기' 버튼 클릭 시
                playButton.onclick = () => {
                    handlePlayClick(itemNumber);
                };

                // HTML에 요소들 추가
                buttons.appendChild(recordButton);
                buttons.appendChild(playButton);
                buttons.appendChild(rerecordButton);

                item.appendChild(itemNumberSpan);
                item.appendChild(buttons);

                listContainer.appendChild(item);
            }
        }
    </script>

</body>
</html>